<div class="grid h-full">
  <div
    class="col-3 flex flex-column border-right-1 bg-white border-300 h-full p-0"
  >
    <div class="p-2 border-bottom-1 border-300 flex align-items-center gap-2">
      <i class="pi pi-comments text-base"></i>
      <h4 class="m-0 font-medium text-base">{{ "chat_flow" | translate }}</h4>
      <div class="flex gap-2 ml-auto">
        <a
          (click)="addNode()"
          class="hover:text-primary"
          [pTooltip]="'add_template' | translate"
          tooltipPosition="bottom"
        >
          <i class="pi pi-plus"></i>
        </a>
        <a
          (click)="saveFullFlow()"
          class="hover:text-primary"
          [pTooltip]="'save_flow' | translate"
          tooltipPosition="bottom"
        >
          <i class="pi pi-save"></i>
        </a>
      </div>
    </div>
    <div class="p-2 flex-1 overflow-y-auto my-2">
      @for (node of nodes(); track $index) {
      <div
        class="node-item flex gap-2 justify-content-between align-items-center bg-white p-2 mb-2 border-round cursor-pointer"
        [class.active]="isNodeActive(node.id)"
        (click)="openEditor(node)"
      >
        <div class="flex flex-1 align-items-center gap-2 min-w-0">
          <div
            class="w-2rem h-2rem flex flex-shrink-0 align-items-center justify-content-center border-circle bg-blue-50 text-primary"
          >
            <i class="pi pi-comment font-semibold"></i>
          </div>
          <div class="flex-1 min-w-0">
            <span
              class="block font-medium text-sm white-space-nowrap line-clamp-1"
              [pTooltip]="
                node.data.name || ('template' | translate) + ' ' + ($index + 1)
              "
              tooltipPosition="top"
            >
              {{
                (node.data.name || ("template" | translate)) +
                  " " +
                  ($index + 1)
              }}
            </span>
            <small
              class="block text-primary text-xs white-space-nowrap line-clamp-1"
              [pTooltip]="node.data.message_text || ('no_message' | translate)"
              tooltipPosition="top"
              >{{ node.data.message_text || ("no_message" | translate) }}</small
            >
          </div>
        </div>

        <div class="flex gap-1">
          <button
            pButton
            icon="pi pi-pencil text-xs"
            class="p-button-text p-button-sm p-button-rounded p-0"
            (click)="openEditor(node); $event.stopPropagation()"
          ></button>

          <button
            pButton
            icon="pi pi-trash text-xs"
            class="p-button-text p-button-sm p-button-rounded p-button-danger"
            (click)="deleteNode(node); $event.stopPropagation()"
          ></button>
        </div>
      </div>
      }
    </div>
  </div>

  <div
    class="col-9 canvas-area"
    (mousemove)="onCanvasMouseMove($event)"
    (click)="cancelConnection()"
  >
    <f-flow fDraggable>
      <f-canvas>
        <!-- ⭐ NEW: Connections with labels -->
        @for (c of connections(); track c.id) {
        <f-connection
          [fOutputId]="c.source"
          [fInputId]="c.target"
          fType="segment"
        >
        </f-connection>
        } @if (isDraggingConnection() && connectionSource()) {
        <svg class="preview-line">
          <defs>
            <marker
              id="arrowhead-preview"
              markerWidth="10"
              markerHeight="10"
              refX="9"
              refY="3"
              orient="auto"
            >
              <polygon points="0 0, 10 3, 0 6" fill="#3B82F6" />
            </marker>
          </defs>
          <line
            [attr.x1]="connectionSource()!.x + 130"
            [attr.y1]="connectionSource()!.y + 80"
            [attr.x2]="pointer().x"
            [attr.y2]="pointer().y"
            stroke="#3B82F6"
            stroke-width="2"
            stroke-dasharray="5,5"
            marker-end="url(#arrowhead-preview)"
          />
        </svg>
        }

        <!-- Nodes -->
        @for (node of nodes(); track $index) {
        <div
          fNode
          fDragHandle
          [fNodePosition]="{ x: node.x, y: node.y }"
          fNodeInput
          fNodeOutput
          [fInputId]="node.id"
          [fOutputId]="node.id"
          class="flow-node"
          [class.active]="isNodeActive(node.id)"
          (click)="selectNodeForConnection(node, $event)"
          (dblclick)="openEditor(node)"
          fOutputConnectableSide="right"
        >
          <div class="node-header p-2 bg-primary text-white border-round-top">
            <div class="flex flex-1 align-items-center gap-2 min-w-0">
              <div
                class="w-2rem h-2rem flex flex-shrink-0 align-items-center justify-content-center border-circle bg-white-alpha-20"
              >
                <i class="pi pi-comment font-semibold"></i>
              </div>
              <div class="flex-1 min-w-0">
                <span
                  class="block font-medium text-sm white-space-nowrap line-clamp-1"
                  [pTooltip]="
                    node.data.name ||
                    ('template' | translate) + ' ' + ($index + 1)
                  "
                  tooltipPosition="top"
                >
                  {{
                    (node.data.name || ("template" | translate)) +
                      " " +
                      ($index + 1)
                  }}
                </span>
              </div>
            </div>
          </div>

          <div class="node-content p-2 bg-white">
            <small
              class="block text-color-secondary text-xs white-space-nowrap line-clamp-2"
              [pTooltip]="node.data.message_text || ('no_message' | translate)"
              tooltipPosition="top"
            >
              {{ node.data.message_text || ("no_message" | translate) }}
            </small>

            <!-- ⭐ NEW: Show options with connection buttons -->
            @if (node.data.options && node.data.options.length > 0) {
            <div class="mt-2">
              <div class="text-xs font-semibold text-500 mb-1">
                {{ "options" | translate }}:
              </div>
              @for (option of node.data.options; track $index) {
              <div
                class="flex align-items-center gap-2 mb-1 p-1 border-round bg-blue-50"
              >
                <span class="flex-1 text-xs">{{
                  option.title || ("option" | translate) + " " + ($index + 1)
                }}</span>

                <!-- Connection indicator -->
                @if (option.next_node_id) {
                <i
                  class="pi pi-check-circle text-green-500 text-xs"
                  [pTooltip]="'connected' | translate"
                  tooltipPosition="left"
                ></i>
                } @else {
                <a
                  pButton
                  [pTooltip]="'click_to_connect_this_option' | translate"
                  tooltipPosition="left"
                  (click)="startConnectionFromOption(node, $index, $event)"
                  class="p-button-text p-button-sm p-0"
                  ><i class="pi pi-link text-xs"></i
                ></a>
                }
              </div>
              }
            </div>
            }
          </div>

          <!-- Connection points -->
          <div
            class="connection-point connection-input"
            [pTooltip]="'Input'"
            tooltipPosition="left"
          ></div>
          <div
            class="connection-point connection-output"
            [pTooltip]="'Output'"
            tooltipPosition="right"
          ></div>
        </div>
        }
      </f-canvas>
    </f-flow>
  </div>
</div>

<!-- EDITOR SIDEBAR -->
@if (selectedNode()) {
<div class="node-editor flex flex-column h-full">
  <div
    class="p-2 bg-primary text-white flex align-items-center justify-content-between"
  >
    <div class="flex align-items-center gap-2">
      <i class="pi pi-pencil text-base"></i>
      <h3 class="font-medium text-base m-0">
        {{ "edit_template" | translate }}
      </h3>
    </div>
    <button
      pButton
      icon="pi pi-times"
      class="p-button-text p-button-sm p-button-rounded text-white hover:text-primary"
      (click)="closeEditor()"
    ></button>
  </div>

  <div class="p-3 flex-1 overflow-y-auto">
    <form [formGroup]="templateForm" (ngSubmit)="submit()">
      <div>
        <formly-form [model]="model" [fields]="fields" [form]="templateForm" />
      </div>

      <!-- ⭐ NEW: Visual connection summary -->
      @if (selectedNode()!.data.options && selectedNode()!.data.options.length >
      0) {
      <div class="mt-3 border-1 border-300 border-round bg-blue-50">
        <div class="font-semibold text-sm mb-2 text-primary">
          <i class="pi pi-sitemap m-2"></i>{{ "routing_preview" | translate }}
        </div>
        @for (option of selectedNode()!.data.options; track $index) {
        <div class="flex align-items-center gap-2 mb-2 text-xs m-2">
          <i class="pi pi-angle-right text-primary"></i>
          <span class="font-medium">{{
            option.title || ("option" | translate) + " " + ($index + 1)
          }}</span>
          <i class="pi pi-arrow-right text-400"></i>
          @if (option.next_node_id) {
          <span class="text-success font-semibold">
            {{ getNextNodeName(option.next_node_id) }}
          </span>
          } @else {
          <span class="text-400 italic">{{ "not_connected" | translate }}</span>
          }
        </div>
        }
      </div>
      }
    </form>
  </div>

  <div class="p-2 border-top-1 border-300">
    <button
      pButton
      size="small"
      [label]="'save_changes' | translate"
      icon="pi pi-check"
      class="p-button-success w-full"
      (click)="saveNode()"
    ></button>
  </div>
</div>
}
