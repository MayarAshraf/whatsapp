@if(!isWorkspaceOpened()){
<div class="table-card overflow-auto h-full">
  <div class="grid">
    <div class="col-12 sm:col-9">
      <h2 class="m-0 text-xl font-semibold">
        <i class="fa fa-solid fa-robot"></i>
        {{ "whatsapp_templates" | translate }}
      </h2>
    </div>
    <div class="col-12 sm:col-3 ml-auto">
      <button
        pButton
        [label]="'create_chat_flow' | translate"
        icon="pi pi-plus font-semibold"
        [outlined]="true"
        class="w-full"
        (click)="openWorkspace()"
      ></button>
    </div>
    @if(!isLoading()){ @for (flow of flows(); track $index) {
    <div class="col-12 md:col-3">
      <div class="border-round shadow-1 overflow-hidden border-1 border-200">
        <div class="p-2 flex flex-column gap-1 surface-200">
          <div class="flex gap-2 justify-content-end">
            @if(flow.is_default){
            <p-tag
              severity="secondary"
              [value]="'default' | translate"
              styleClass="font-semibold p-1 h-1.5rem text-xs"
            />
            } @if(flow.is_active){
            <p-tag
              icon="pi pi-check"
              severity="success"
              styleClass="font-semibold p-1 h-1.5rem text-xs"
              [value]="'active' | translate"
            />
            }
          </div>
          <h2
            class="m-0 font-medium text-lg text-overflow-ellipsis overflow-hidden white-space-nowrap"
            [pTooltip]="flow.name"
            tooltipPosition="top"
          >
            {{ flow.name }}
          </h2>
        </div>
        <div class="p-2 flex flex-auto justify-content-between h-full">
          <div
            class="flex flex-column gap-1 align-items-center justify-content-center p-2 border-round bg-blue-50"
          >
            <i class="fa-regular fa-message text-primary"></i>
            <span class="text-primary font-bold line-height-1">8</span>
            <span class="line-height-1 text-sm text-500 text-xs font-medium">{{
              "templates" | translate
            }}</span>
          </div>
          <div
            class="flex flex-column gap-1 align-items-center justify-content-center p-2 border-round bg-pink-50"
          >
            <i class="fa-solid fa-code-fork text-pink-700"></i>
            <span class="font-bold text-pink-700 line-height-1">8</span>
            <span class="line-height-1 text-sm text-500 text-xs font-medium">{{
              "connections" | translate
            }}</span>
          </div>
        </div>
        <div class="px-2 text-xs">
          <span class="text-500"
            ><i class="fa-regular fa-user"></i> John Doe</span
          >
          <span class="text-500 mx-2"
            ><i class="fa-regular fa-calendar"></i>
            {{ flow.updated_at | date : "shortTime" }}
          </span>
        </div>
        <div class="p-2">
          <button
            pButton
            size="small"
            [label]="'view' | translate"
            icon="fa-solid fa-eye"
            [outlined]="true"
            class="w-full"
            (click)="openWorkspace(flow.id)"
          ></button>
        </div>
      </div>
    </div>
    }@empty{
    <p>{{ "no_chat_flows_yet" | translate }}</p>
    }}@else{ @for (i of [1, 2, 3, 4]; track $index) {
    <div class="col-12 md:col-3">
      <p-skeleton width="100%" height="15rem" />
    </div>
    } }
  </div>
</div>
}@else{
<div class="grid h-full">
  <div
    class="col-12 md:col-3 flex flex-column border-right-1 bg-white border-300 h-full p-0"
  >
    <div class="p-2 border-bottom-1 border-300 flex align-items-center gap-2">
      <i class="pi pi-comments text-base"></i>
      <h4 class="m-0 font-medium text-base">{{ "chat_flow" | translate }}</h4>
      <div class="flex gap-2 ml-auto">
        <a
          (click)="undo()"
          [class.disabled]="!canUndo()"
          class="hover:text-primary"
          [class.text-400]="!canUndo()"
          [pTooltip]="'undo' | translate"
          tooltipPosition="bottom"
          ><i class="pi pi-undo"></i>
        </a>
        <a
          (click)="redo()"
          [class.disabled]="!canRedo()"
          class="hover:text-primary"
          [class.text-400]="!canRedo()"
          [pTooltip]="'redo' | translate"
          tooltipPosition="bottom"
          ><i class="pi pi-refresh"></i>
        </a>
        <a
          (click)="clearWorkspace()"
          class="hover:text-primary"
          [pTooltip]="'clear_workspace' | translate"
          tooltipPosition="bottom"
          ><i class="fa-solid fa-eraser"></i>
        </a>
        <a
          (click)="addNode()"
          class="hover:text-primary"
          [pTooltip]="'add_template' | translate"
          tooltipPosition="bottom"
        >
          <i class="pi pi-plus"></i>
        </a>
        <a
          (click)="openFlowDialog()"
          class="hover:text-primary"
          [pTooltip]="'save_flow' | translate"
          tooltipPosition="bottom"
        >
          <i class="pi pi-save"></i>
        </a>
      </div>
    </div>
    <div class="p-2 flex-1 overflow-y-auto my-2">
      @for (node of nodes(); track $index) {
      <div
        class="node-item flex gap-2 justify-content-between align-items-center bg-white p-1 mb-2 border-round cursor-pointer"
        [class.active]="isNodeActive(node.step_key)"
        (click)="openEditor(node)"
      >
        <div class="flex flex-1 align-items-center gap-2 min-w-0">
          <div
            class="w-1.5rem h-1.5rem flex flex-shrink-0 align-items-center justify-content-center border-circle bg-blue-50 text-primary"
          >
            <i class="pi pi-comment font-semibold text-xs"></i>
          </div>
          <div class="flex-1 min-w-0">
            @let preview = getNodePreview(node);
            <span
              class="block font-medium text-xs white-space-nowrap line-clamp-1"
              [pTooltip]="
                preview.name || ('template' | translate) + ' ' + ($index + 1)
              "
              tooltipPosition="top"
            >
              {{
                preview.name || ("template" | translate) + " " + ($index + 1)
              }}
            </span>
            <small
              class="block text-primary white-space-nowrap line-clamp-1"
              style="font-size: 10px"
              [pTooltip]="preview.message_content || ('no_message' | translate)"
              tooltipPosition="top"
            >
              {{ preview.message_content || ("no_message" | translate) }}</small
            >
          </div>
        </div>

        <div class="flex gap-1">
          <button
            pButton
            icon="pi pi-pencil text-xs"
            class="p-button-text p-button-rounded w-1.5rem h-1.5rem"
            (click)="openEditor(node); $event.stopPropagation()"
          ></button>

          <button
            pButton
            icon="pi pi-trash text-xs"
            class="p-button-text p-button-rounded p-button-danger w-1.5rem h-1.5rem"
            (click)="deleteNode(node); $event.stopPropagation()"
          ></button>
        </div>
      </div>
      }
    </div>
  </div>

  <div class="col-12 md:col-9">
    <f-flow
      fDraggable
      (fLoaded)="onLoaded()"
      (fCreateConnection)="addConnection($event)"
    >
      <f-line-alignment [fAlignThreshold]="10"></f-line-alignment>

      @switch (background()) { @case ('circle') {
      <f-background>
        <f-circle-pattern />
      </f-background>
      } @case ('rect') {
      <f-background>
        <f-rect-pattern />
      </f-background>
      } }
      <f-canvas [fZoom]="true">
        <f-connection-for-create fType="segment"></f-connection-for-create>
        <f-snap-connection
          [fSnapThreshold]="50"
          fType="segment"
        ></f-snap-connection>

        @for (connection of connections(); track connection.id) {
        <f-connection
          [fReassignDisabled]="true"
          fType="segment"
          [fOutputId]="connection.fOutputId"
          [fInputId]="connection.fInputId"
          (mouseenter)="onConnectionMouseEnter(connection.id)"
          (mouseleave)="onConnectionMouseLeave(connection.id)"
          [style]="{
            cursor: 'pointer',
            'stroke-width': '1.5',
            'stroke-dasharray':
              hoveredConnection() === connection.id ||
              selectedConnection()?.id === connection.id
                ? '5,3'
                : 'none',
            opacity: hoveredConnection() === connection.id ? '0.9' : '1',
            transition: 'all 0.2s ease'
          }"
          (click)="onConnectionClick($event, connection)"
        >
          <div fConnectionContent class="connection-label">
            {{ getConnectionLabel(connection) }}
          </div>
          <svg
            viewBox="0 0 700 700"
            fMarker
            [type]="eMarkerType.START"
            class="connection-marker"
            [height]="5"
            [width]="5"
            [refX]="2.5"
            [refY]="2.5"
            markerUnits="strokeWidth"
          >
            <circle cx="350" cy="350" r="350" />
          </svg>
          <svg
            viewBox="0 0 700 700"
            fMarker
            [type]="eMarkerType.SELECTED_START"
            class="connection-marker"
            [height]="5"
            [width]="5"
            [refX]="2.5"
            [refY]="2.5"
            markerUnits="strokeWidth"
          >
            <circle cx="350" cy="350" r="350" />
          </svg>
          <svg
            viewBox="0 0 6 7"
            fMarker
            [type]="eMarkerType.END"
            class="connection-marker"
            [height]="7"
            [width]="6"
            [refX]="5.5"
            [refY]="3.5"
            markerUnits="strokeWidth"
            orient="auto"
          >
            <path d="M0.000391006 0L6 3.5L0.000391006 7L0.000391006 0Z" />
          </svg>
          <svg
            viewBox="0 0 6 7"
            fMarker
            [type]="eMarkerType.SELECTED_END"
            class="connection-marker"
            [height]="7"
            [width]="6"
            [refX]="5.5"
            [refY]="3.5"
            markerUnits="strokeWidth"
            orient="auto"
          >
            <path d="M0.000391006 0L6 3.5L0.000391006 7L0.000391006 0Z" />
          </svg>
        </f-connection>
        } @for (node of nodes(); track $index) {
        <div
          fNode
          fDragHandle
          [fNodePosition]="{ x: node.x, y: node.y }"
          (dblclick)="openEditor(node)"
          (click)="activeNodeStepKey.set(node.step_key)"
          (fNodePositionChange)="onNodePositionChange($event, node.step_key)"
          (mouseenter)="onNodeMouseEnter(node.step_key)"
          (mouseleave)="onNodeMouseLeave(node.step_key)"
        >
          <div
            fNodeInput
            [fInputId]="node.step_key"
            [fInputMultiple]="true"
            class="left"
            [fInputConnectableSide]="eConnectableSide.CALCULATE"
          ></div>
          <div
            fNodeOutput
            [fOutputId]="node.step_key"
            [fOutputMultiple]="true"
            [isSelfConnectable]="false"
            class="right"
            [fOutputConnectableSide]="eConnectableSide.CALCULATE"
          ></div>
          <div class="flow-node" [class.active]="isNodeActive(node.step_key)">
            @if (hoveredNode() === node.step_key) {
            <button
              pButton
              icon="pi pi-pencil text-xs"
              class="node-action-button open p-button-rounded bg-white"
              [outlined]="true"
              [pTooltip]="'open_template' | translate"
              tooltipPosition="top"
              (click)="openEditor(node); $event.stopPropagation()"
            ></button>
            <button
              pButton
              icon="fa-solid fa-plus text-xs"
              class="node-action-button add p-button-rounded bg-white"
              [outlined]="true"
              [pTooltip]="'add_template' | translate"
              tooltipPosition="top"
              (click)="addNodeConnectedTo(node); $event.stopPropagation()"
            ></button>
            }
            <div
              class="flex align-items-center gap-1 p-1 bg-primary text-white border-round-top-xl"
            >
              <div
                class="w-1.5rem h-1.5rem flex flex-shrink-0 align-items-center justify-content-center border-circle bg-white-alpha-20"
              >
                <i class="pi pi-comment font-semibold text-xs"></i>
              </div>
              <div class="min-w-0">
                @let preview = getNodePreview(node);
                <span
                  class="block font-medium text-xs white-space-nowrap line-clamp-1"
                  [pTooltip]="
                    preview.name ||
                    ('template' | translate) + ' ' + ($index + 1)
                  "
                  tooltipPosition="top"
                >
                  {{
                    preview.name ||
                      ("template" | translate) + " " + ($index + 1)
                  }}
                </span>
              </div>
            </div>

            <div class="p-1 bg-white border-round-bottom-xl">
              <small
                class="block text-color-secondary text-xs white-space-nowrap line-clamp-2"
                [pTooltip]="
                  preview.message_content || ('no_message' | translate)
                "
                tooltipPosition="top"
              >
                {{ preview.message_content || ("no_message" | translate) }}
              </small>

              @if (getPreviewOptions(preview.options).length) {
              <div>
                <div class="text-xs font-semibold text-500 mb-1">
                  {{ "options" | translate }}:
                </div>
                @for (option of getPreviewOptions(preview.options); track
                $index) {
                <div
                  class="flex align-items-center gap-2 mb-1 p-1 border-round bg-blue-50"
                >
                  <span
                    class="flex-1 text-xs white-space-nowrap line-clamp-1"
                    [pTooltip]="option?.title || ('no_message' | translate)"
                    tooltipPosition="left"
                    >{{
                      option?.title ||
                        ("option" | translate) + " " + ($index + 1)
                    }}</span
                  >
                  @if (option?.action_type === 'jump_to_step') { @if
                  (option?.target_step_key) {
                  <i
                    class="fa-regular fa-circle-check text-green-500 text-xs"
                    [pTooltip]="'connected' | translate"
                    tooltipPosition="left"
                  ></i>
                  } @else {
                  <a
                    pButton
                    [pTooltip]="'click_to_connect_this_option' | translate"
                    tooltipPosition="left"
                    class="p-button-text p-button-sm p-0 h-1rem"
                    (click)="openConnectMenu($event, node, $index)"
                  >
                    <i class="fa-solid fa-link text-xs"></i>
                  </a>
                  } }@else if (option?.action_type === 'assign_to_group') {
                  <i
                    class="fa-solid fa-users text-xs"
                    [pTooltip]="'assign_to_group' | translate"
                    tooltipPosition="left"
                  ></i>
                  } @else if (option?.action_type === 'assign_to_user') {
                  <i
                    class="fa-solid fa-user text-xs"
                    [pTooltip]="'assign_to_user' | translate"
                    tooltipPosition="left"
                  ></i>
                  }
                </div>
                }
              </div>
              }
            </div>
          </div>
        </div>
        }
      </f-canvas>
    </f-flow>
    <div class="flow-toolbar">
      <p-select
        size="small"
        appendTo="body"
        [options]="backgroundOptions"
        [(ngModel)]="background"
        [placeholder]="'choose_background' | translate"
        class="h-2rem border-none font-semibold"
      />
      <button (click)="onZoomIn()"><i class="pi pi-search-plus"></i></button>
      <button (click)="onZoomOut()"><i class="pi pi-search-minus"></i></button>
      <button (click)="reset()">{{ "reset" | translate }}</button>
    </div>
  </div>
</div>

<p-menu
  #connectMenu
  [model]="connectMenuItems()"
  [popup]="true"
  appendTo="body"
></p-menu>

@if (selectedNode()) {
<div class="node-editor flex flex-column h-full">
  <div
    class="p-2 bg-primary text-white flex align-items-center justify-content-between"
  >
    <div class="flex align-items-center gap-2">
      <i class="pi pi-sitemap text-base"></i>
      <h3 class="font-medium text-base m-0">
        {{ "template" | translate }}
      </h3>
    </div>
    <button
      pButton
      icon="pi pi-times"
      class="p-button-text p-button-sm p-button-rounded text-white hover:text-primary"
      (click)="closeEditor()"
    ></button>
  </div>

  <div class="p-3 flex-1 overflow-y-auto">
    <form [formGroup]="templateForm" (ngSubmit)="saveNode()">
      <div>
        <formly-form
          [model]="templateModel"
          [fields]="Templatefields"
          [form]="templateForm"
        />
      </div>

      @if (getPreviewOptions(selectedNode()?.data?.options).length) {
      <div class="mt-3 border-1 border-300 border-round bg-blue-50">
        <div class="font-semibold text-sm mb-2 text-primary">
          <i class="pi pi-sitemap m-2"></i>{{ "routing_preview" | translate }}
        </div>
        @for (option of selectedNode()?.data?.options; track $index) {
        <div class="flex align-items-center gap-2 mb-2 text-xs m-2">
          <i class="pi pi-angle-right text-primary"></i>
          <span class="font-medium">{{
            option?.title || ("option" | translate) + " " + ($index + 1)
          }}</span>
          <i class="pi pi-arrow-right text-400"></i>
          @if (option?.target_step_key) {
          <span class="text-success font-semibold">
            {{ getNextNodeName(option.target_step_key) }}
          </span>
          } @else {
          <span class="text-400 italic">{{ "not_connected" | translate }}</span>
          }
        </div>
        }
      </div>
      }
    </form>
  </div>

  <div class="p-2 border-top-1 border-300">
    <button
      pButton
      size="small"
      [label]="'save_changes' | translate"
      icon="pi pi-check"
      class="p-button-success w-full"
      (click)="saveNode()"
    ></button>
  </div>
</div>
}

<p-dialog
  [header]="'template_flow' | translate"
  [modal]="true"
  [(visible)]="templatevisible"
  [closable]="true"
  [style]="{ width: '30rem', 'max-width': '90vw' }"
  [closeOnEscape]="true"
>
  <div class="p-2">
    <form [formGroup]="flowForm" (ngSubmit)="saveFlow()">
      <formly-form
        [model]="flowModel"
        [fields]="flowFields"
        [form]="flowForm"
      />
    </form>
  </div>
  <ng-template #footer>
    <p-button
      [label]="'cancel' | translate"
      [text]="true"
      severity="secondary"
      (click)="templatevisible.set(false)"
    />
    <p-button
      [label]="'save_flow' | translate"
      [outlined]="true"
      [loading]="isFlowLoading()"
      severity="secondary"
      (click)="saveFlow()"
    />
  </ng-template>
</p-dialog>
} @if (connectionMenuVisible()) {
<div
  class="connection-menu"
  [style.left.px]="connectionMenuPosition().x"
  [style.top.px]="connectionMenuPosition().y"
  (click)="$event.stopPropagation()"
>
  <div class="menu-title">
    {{ "connections" | translate }}
  </div>

  @for (option of connectionMenuOptions(); track option.optionIndex) {
  <div class="menu-item" (click)="deleteConnectionWith(option.optionIndex)">
    <i class="pi pi-trash text-red-500"></i>
    {{ option.optionTitle }}
  </div>
  } @if (connectionMenuOptions().length > 1) {
  <div class="menu-divider"></div>

  <div class="menu-item text-red-500" (click)="deleteAllConnections()">
    <i class="pi pi-times-circle"></i>
    {{ "delete_all_connections" | translate }}
  </div>
  }
</div>
}
