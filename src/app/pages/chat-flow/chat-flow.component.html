@if(!isWorkspaceOpened()){
<div class="table-card overflow-auto h-full">
  <div class="grid">
    <div class="col-12 sm:col-9">
      <h2 class="m-0 text-xl font-semibold">
        <i class="fa fa-solid fa-robot"></i>
        {{ "whatsapp_templates" | translate }}
      </h2>
    </div>
    <div class="col-12 sm:col-3 ml-auto">
      <button
        pButton
        [label]="'create_chat_flow' | translate"
        icon="pi pi-plus font-semibold"
        [outlined]="true"
        class="w-full"
        (click)="openWorkspace()"
      ></button>
    </div>
    @if(!isLoading()){ @for (flow of flows(); track $index) {
    <div class="col-12 md:col-4">
      <div class="border-round shadow-1 overflow-hidden border-1 border-200">
        <div class="p-2 flex flex-column gap-1 bg-primary-500">
          <div class="flex gap-2 justify-content-end">
            @if(flow.is_default){
            <p-tag
              severity="secondary"
              [value]="'default' | translate"
              styleClass="font-semibold p-1 h-1.5rem text-xs"
            />
            } @if(flow.is_active){
            <p-tag
              icon="pi pi-check"
              severity="success"
              styleClass="font-semibold p-1 h-1.5rem text-xs"
              [value]="'active' | translate"
            />
            }
          </div>
          <h2
            class="m-0 font-medium text-lg text-white text-overflow-ellipsis overflow-hidden white-space-nowrap"
            [pTooltip]="flow.name"
            tooltipPosition="top"
          >
            {{ flow.name }}
          </h2>
        </div>
        <div class="p-2 flex flex-auto justify-content-between h-full">
          <div
            class="flex flex-column gap-1 align-items-center justify-content-center p-2 border-round bg-blue-50"
          >
            <i class="fa-regular fa-message text-primary"></i>
            <span class="text-primary font-bold line-height-1">8</span>
            <span class="line-height-1 text-sm text-500 text-xs font-medium">{{
              "templates" | translate
            }}</span>
          </div>
          <div
            class="flex flex-column gap-1 align-items-center justify-content-center p-2 border-round bg-pink-50"
          >
            <i class="fa-solid fa-code-fork text-pink-700"></i>
            <span class="font-bold text-pink-700 line-height-1">8</span>
            <span class="line-height-1 text-sm text-500 text-xs font-medium">{{
              "connections" | translate
            }}</span>
          </div>
        </div>
        <div class="px-2 text-xs">
          <span class="text-500"
            ><i class="fa-regular fa-user"></i> John Doe</span
          >
          <span class="text-500 mx-2"
            ><i class="fa-regular fa-calendar"></i>
            {{ flow.updated_at | date : "shortTime" }}
          </span>
        </div>
        <div class="p-2">
          <button
            pButton
            size="small"
            [label]="'view' | translate"
            icon="fa-solid fa-eye"
            [outlined]="true"
            class="w-full"
            (click)="openWorkspace(flow.id)"
          ></button>
        </div>
      </div>
    </div>
    }@empty{
    <p>{{ "no_chat_flows_yet" | translate }}</p>
    }}@else{
    <div class="col-12 text-center">
      <i class="pi pi-spinner pi-spin text-2xl text-primary"></i>
    </div>
    }
  </div>
</div>
}@else{
<div class="grid h-full">
  <div
    class="col-12 md:col-3 flex flex-column border-right-1 bg-white border-300 h-full p-0"
  >
    <div class="p-2 border-bottom-1 border-300 flex align-items-center gap-2">
      <i class="pi pi-comments text-base"></i>
      <h4 class="m-0 font-medium text-base">{{ "chat_flow" | translate }}</h4>
      <div class="flex gap-2 ml-auto">
        <a
          (click)="addNode()"
          class="hover:text-primary"
          [pTooltip]="'add_template' | translate"
          tooltipPosition="bottom"
        >
          <i class="pi pi-plus"></i>
        </a>
        <a
          (click)="openFlowDialog()"
          class="hover:text-primary"
          [pTooltip]="'save_flow' | translate"
          tooltipPosition="bottom"
        >
          <i class="pi pi-save"></i>
        </a>
      </div>
    </div>
    <div class="p-2 flex-1 overflow-y-auto my-2">
      @for (node of nodes(); track $index) {
      <div
        class="node-item flex gap-2 justify-content-between align-items-center bg-white p-1 mb-2 border-round cursor-pointer"
        [class.active]="isNodeActive(node.step_key)"
        (click)="openEditor(node)"
      >
        <div class="flex flex-1 align-items-center gap-2 min-w-0">
          <div
            class="w-1.5rem h-1.5rem flex flex-shrink-0 align-items-center justify-content-center border-circle bg-blue-50 text-primary"
          >
            <i class="pi pi-comment font-semibold text-xs"></i>
          </div>
          <div class="flex-1 min-w-0">
            <span
              class="block font-medium text-xs white-space-nowrap line-clamp-1"
              [pTooltip]="
                node.data.name || ('template' | translate) + ' ' + ($index + 1)
              "
              tooltipPosition="top"
            >
              {{
                (node.data.name || ("template" | translate)) +
                  " " +
                  ($index + 1)
              }}
            </span>
            <small
              class="block text-primary white-space-nowrap line-clamp-1"
              style="font-size: 10px"
              [pTooltip]="
                node.data.message_content || ('no_message' | translate)
              "
              tooltipPosition="top"
              >{{
                node.data.message_content || ("no_message" | translate)
              }}</small
            >
          </div>
        </div>

        <div class="flex gap-1">
          <button
            pButton
            icon="pi pi-pencil text-xs"
            class="p-button-text p-button-rounded w-1.5rem h-1.5rem"
            (click)="openEditor(node); $event.stopPropagation()"
          ></button>

          <button
            pButton
            icon="pi pi-trash text-xs"
            class="p-button-text p-button-rounded p-button-danger w-1.5rem h-1.5rem"
            (click)="deleteNode(node); $event.stopPropagation()"
          ></button>
        </div>
      </div>
      }
    </div>
  </div>

  <div
    class="col-12 md:col-9"
    (click)="cancelConnection(); closeConnectionMenu()"
  >
    <f-flow fDraggable>
      <f-background>
        <f-rect-pattern></f-rect-pattern>
      </f-background>
      <f-canvas>
        @for (c of mergedConnections(); track c.id) {
        <f-connection
          [fOutputId]="c.source"
          [fInputId]="c.target"
          fType="segment"
          [fSelectionDisabled]="true"
          [fBehavior]="eConnectionBehaviour.FIXED"
          (click)="onConnectionClick(c, $event)"
          (mouseenter)="onConnectionMouseEnter(c.id)"
          (mouseleave)="onConnectionMouseLeave(c.id)"
          [style]="{
            cursor: 'pointer',
            'stroke-width': '1.5',
            'stroke-dasharray':
              hoveredConnection() === c.id || selectedConnection() === c.id
                ? '5,3'
                : 'none',
            opacity: hoveredConnection() === c.id ? '0.9' : '1',
            transition: 'all 0.2s ease'
          }"
        >
          <svg
            viewBox="0 0 10 10"
            fMarker
            [type]="eMarkerType.START"
            [height]="10"
            [width]="10"
            [refX]="5"
            [refY]="5"
          >
            <circle cx="5" cy="5" r="2" stroke="none" fill="#3B82F6"></circle>
          </svg>
          <svg
            viewBox="0 0 700 700"
            fMarker
            [type]="eMarkerType.END"
            [height]="15"
            [width]="15"
            [refX]="9"
            [refY]="8"
          >
            <path fill="#3B82F6" d="M0,0L700,350L0,700L150,350z" />
          </svg>
        </f-connection>
        } @for (node of nodes(); track $index) {
        <div
          fNode
          fDragHandle
          [fNodePosition]="{ x: node.x, y: node.y }"
          fNodeInput
          fNodeOutput
          [fInputId]="node.step_key"
          [fOutputId]="node.step_key"
          class="flow-node"
          [class.active]="isNodeActive(node.step_key)"
          (click)="selectNodeForConnection(node, $event)"
          (dblclick)="openEditor(node)"
          fInputConnectableSide="top"
          fOutputConnectableSide="right"
          (fNodePositionChange)="onNodePositionChange($event, node.step_key)"
        >
          <div class="node-header p-1 bg-primary text-white border-round-top">
            <div class="flex flex-1 align-items-center gap-2 min-w-0">
              <div
                class="w-1.5rem h-1.5rem flex flex-shrink-0 align-items-center justify-content-center border-circle bg-white-alpha-20"
              >
                <i class="pi pi-comment font-semibold text-xs"></i>
              </div>
              <div class="flex-1 min-w-0">
                <span
                  class="block font-medium text-xs white-space-nowrap line-clamp-1"
                  [pTooltip]="
                    node.data.name ||
                    ('template' | translate) + ' ' + ($index + 1)
                  "
                  tooltipPosition="top"
                >
                  {{
                    (node.data.name || ("template" | translate)) +
                      " " +
                      ($index + 1)
                  }}
                </span>
              </div>
            </div>
          </div>

          <div class="p-1 bg-white">
            <small
              class="block text-color-secondary text-xs white-space-nowrap line-clamp-2"
              [pTooltip]="
                node.data.message_content || ('no_message' | translate)
              "
              tooltipPosition="top"
            >
              {{ node.data.message_content || ("no_message" | translate) }}
            </small>

            @if (node.data.options && node.data.options.length > 0) {
            <div class="mt-2">
              <div class="text-xs font-semibold text-500 mb-1">
                {{ "options" | translate }}:
              </div>
              @for (option of node.data.options; track $index) {
              <div
                class="flex align-items-center gap-2 mb-1 p-1 border-round bg-blue-50"
              >
                <span class="flex-1 text-xs">{{
                  option?.title || ("option" | translate) + " " + ($index + 1)
                }}</span>

                @if (option?.target_step_key) {
                <i
                  class="pi pi-check-circle text-green-500 text-xs"
                  [pTooltip]="'connected' | translate"
                  tooltipPosition="left"
                ></i>
                } @else {
                <a
                  pButton
                  [pTooltip]="'click_to_connect_this_option' | translate"
                  tooltipPosition="left"
                  (click)="startConnectionFromOption(node, $index, $event)"
                  class="p-button-text p-button-sm p-0"
                  ><i class="pi pi-link text-xs"></i
                ></a>
                }
              </div>
              }
            </div>
            }
          </div>
        </div>
        }
      </f-canvas>
      @for (c of mergedConnections(); track c.id) {
      <div
        fOverlay
        class="connection-label"
        [style.left.px]="getConnectionMidpoint(c).x"
        [style.top.px]="getConnectionMidpoint(c).y"
        (click)="onConnectionClick(c, $event)"
      >
        {{ getConnectionLabel(c) }}
      </div>
      }
    </f-flow>
  </div>
</div>

@if (selectedNode()) {
<div class="node-editor flex flex-column h-full">
  <div
    class="p-2 bg-primary text-white flex align-items-center justify-content-between"
  >
    <div class="flex align-items-center gap-2">
      <i class="pi pi-pencil text-base"></i>
      <h3 class="font-medium text-base m-0">
        {{ "edit_template" | translate }}
      </h3>
    </div>
    <button
      pButton
      icon="pi pi-times"
      class="p-button-text p-button-sm p-button-rounded text-white hover:text-primary"
      (click)="closeEditor()"
    ></button>
  </div>

  <div class="p-3 flex-1 overflow-y-auto">
    <form [formGroup]="templateForm" (ngSubmit)="saveNode()">
      <div>
        <formly-form
          [model]="templateModel"
          [fields]="Templatefields"
          [form]="templateForm"
        />
      </div>

      @if (selectedNode()?.data?.options &&
      selectedNode()?.data?.options?.length) {
      <div class="mt-3 border-1 border-300 border-round bg-blue-50">
        <div class="font-semibold text-sm mb-2 text-primary">
          <i class="pi pi-sitemap m-2"></i>{{ "routing_preview" | translate }}
        </div>
        @for (option of selectedNode()?.data?.options; track $index) {
        <div class="flex align-items-center gap-2 mb-2 text-xs m-2">
          <i class="pi pi-angle-right text-primary"></i>
          <span class="font-medium">{{
            option?.title || ("option" | translate) + " " + ($index + 1)
          }}</span>
          <i class="pi pi-arrow-right text-400"></i>
          @if (option?.target_step_key) {
          <span class="text-success font-semibold">
            {{ getNextNodeName(option.target_step_key) }}
          </span>
          } @else {
          <span class="text-400 italic">{{ "not_connected" | translate }}</span>
          }
        </div>
        }
      </div>
      }
    </form>
  </div>

  <div class="p-2 border-top-1 border-300">
    <button
      pButton
      size="small"
      [label]="'save_changes' | translate"
      icon="pi pi-check"
      class="p-button-success w-full"
      (click)="saveNode()"
    ></button>
  </div>
</div>
}

<p-dialog
  [header]="'template_flow' | translate"
  [modal]="true"
  [(visible)]="templatevisible"
  [closable]="true"
  [style]="{ width: '30rem', 'max-width': '90vw' }"
  [closeOnEscape]="true"
>
  <div class="p-2">
    <form [formGroup]="flowForm" (ngSubmit)="saveFlow()">
      <formly-form
        [model]="flowModel"
        [fields]="flowFields"
        [form]="flowForm"
      />
    </form>
  </div>
  <ng-template #footer>
    <p-button
      [label]="'cancel' | translate"
      [text]="true"
      severity="secondary"
      (click)="templatevisible.set(false)"
    />
    <p-button
      [label]="'save_flow' | translate"
      [outlined]="true"
      [loading]="isFlowLoading()"
      severity="secondary"
      (click)="saveFlow()"
    />
  </ng-template>
</p-dialog>
} @if (showDeleteOptionsMenu() && selectedConnectionOptions().length > 0) {
<div
  class="p-2 shadow-2 border-round"
  [style]="{
    position: 'fixed',
    top: connectionMenuPosition().y + 'px',
    left: connectionMenuPosition().x + 'px',
    'z-index': 1000,
    background: 'white',
    width: '15rem'
  }"
>
  <div class="text-sm font-semibold mb-2 text-700">
    {{ "select_connection_to_delete" | translate }}
  </div>

  @for (option of selectedConnectionOptions(); track option.connectionId) {
  <button
    pButton
    [label]="option.label"
    icon="pi pi-trash"
    class="p-button-text p-button-sm w-full justify-content-start p-button-danger mb-1"
    (click)="deleteSingleOptionConnection(option.connectionId)"
  ></button>
  }
  <button
    pButton
    [label]="'delete_all_connections' | translate"
    icon="pi pi-trash"
    class="p-button-text p-button-sm w-full justify-content-start p-button-danger mb-2"
    (click)="
      deleteAllConnections(
        selectedConnectionGroup()!.source,
        selectedConnectionGroup()!.target
      )
    "
  ></button>

  <button
    pButton
    [label]="'cancel' | translate"
    icon="pi pi-times"
    class="p-button-text p-button-sm w-full justify-content-start"
    (click)="closeConnectionMenu()"
  ></button>
</div>
} @if (isConnectionMenuVisible() && selectedConnection() &&
!showDeleteOptionsMenu()) {
<div
  class="p-2 shadow-2 border-round"
  [style]="{
    position: 'fixed',
    top: connectionMenuPosition().y + 'px',
    left: connectionMenuPosition().x + 'px',
    'z-index': 1000,
    background: 'white',
    width: '13rem'
  }"
  (clickOutside)="closeConnectionMenu()"
>
  <button
    pButton
    [label]="'delete_connection' | translate"
    icon="pi pi-trash"
    class="p-button-text p-button-sm w-full justify-content-start p-button-danger"
    (click)="deleteSingleOptionConnection(selectedConnection()!)"
  ></button>

  <button
    pButton
    [label]="'cancel' | translate"
    icon="pi pi-times"
    class="p-button-text p-button-sm w-full justify-content-start"
    (click)="closeConnectionMenu()"
  ></button>
</div>
}
